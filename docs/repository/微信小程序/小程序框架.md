# 小程序框架
## 场景值
用户进入小程序的路径。

小程序里App的 `onLaunch` 和 `onShow` 内通过 `wx.getLaunchOptionSync` 获取。

游戏里 `wx.getLaunchOptionSync` 和 `wx.onShow`

[具体场景值](https://developers.weixin.qq.com/miniprogram/dev/reference/scene-list.html)

## 逻辑层

### 注册小程序

通过 `App()` 在 `app.js` 中调用，**必须且只一次**，用于绑定生命周期回调

+ `onLaunch`  初始化，全局**仅一次**，`wx.getLaunchOpitonSync` 获取参数
+ `onShow` 小程序启动或后台进入前台触发，`wx.onAppShow` 绑定监听
+ `onHide` 前台进入后台触发，`wx.onAppHide` 绑定监听
+ `onError` 脚本错误或API调用错误触发，`wx.onError` 绑定监听
+ `onPageNotFound` 打开页面不存在 `wx.onPageNotFound` 绑定监听
+ `onUnhandledRejection` 未处理的Promise 回调失败触发，`wx.onUnhandledRejection` 绑定监听
+ `onThemeChange` 系统切换主题时触发，`wx.onThemeChange` 绑定监听

**前台和后台的区别**

前台 切入小程序

后台 切出小程序，但没有立即销毁，等一定时间(官方5分钟)或CPU占用过高后销毁

### 获取APP实例
```js
var appInstance = getApp()
```

不能定义于`App()`内的函数中，或调用App前调用`getApp()`，可通过`this`获取实例

### 注册页面

小程序每个页面指定`data`、`behaviors`(类似mixins)、生命周期钩子、其他事件操作

**生命周期回调函数**

+ `onLoad` 页面加载触发，**仅一次**
+ `onShow` 页面显示/切入前台触发
+ `onReady` 初次渲染
+ `onHide` 页面隐藏/切入后台触发
+ `onUnload` 页面卸载触发——页面切换 `wx.redirectTo` 或 `wx.navigateBack`

#### 页面事件处理函数

+ `onPullDownRefresh` 下拉刷新
+ `onReachBottom` 上拉触发
+ `onPageScroll` 滚页面触发
+ `onAddToFavorites` 添加收藏按钮，可以自定义收藏内容
+ `onShareAppMessage` 监听用户点击页面转发按钮
+ `onShareTimeline` 监听分享到朋友圈按钮行为，并自定义分享内容
+ `onResize` 屏幕旋转触发
+ `onTabItemTap` 点击tab触发

#### 组件事件处理函数

可以自定义事件处理函数。在渲染层组件添加事件监听，触发执行

### 页面生命周期

### 页面路由

**页面栈**

路由切换以栈的形式，出栈入栈

+ 初始化 新页面入栈
+ 打开新页面 新页面入栈    `navigateTo`
+ 页面重定向 当前页面出栈，新页面入栈 `redirectTo`
+ 页面返回 页面不断出栈，直到目标返回页，可指定数  `navigateBack`
+ Tab切换 页面全部出栈，只留新Tab页面  `switchTab`
+ 重加载 页面全部出栈，只留新页面  `reLaunch`

`getCurrentPages()` 获取当前页面栈，配合 `navigateBack` 返回页面

### 自定义组件

`Component(Object object)` 创建自定义组件，接受一个 `Object` 对象作为参数，对象中可以包含以下属性：

| 定义字段 | 描述 |
| --- | --- |
| properties | 组件的对外属性，是属性名到属性设置的映射表 |
| data |组件的内部数据，和 `properties` 一同用于组件的模板渲染 |
| observers | 组件数据字段监听器，用于监听 `properties` 和 `data` 的变化 |
| methods |	组件的方法，包括事件响应函数和任意的自定义方法，关于事件响应函数的使用 |
| behaviors |	类似于mixins和traits的组件间代码复用机制 |
| created |	组件生命周期函数-在组件实例刚刚被创建时执行，注意此时不能调用 `setData` |
| attached | 组件生命周期函数-在组件实例进入页面节点树时执行 |
| ready |	组件生命周期函数-在组件布局完成后执行 |
| moved |	组件生命周期函数-在组件实例被移动到节点树另一个位置时执行 |
| detached | 组件生命周期函数-在组件实例被从页面节点树移除时执行 |
| relations |	组件间关系定义 |
| externalClasses |	组件接受的外部样式类 |
| options |	一些选项（文档中介绍相关特性时会涉及具体的选项设置，这里暂不列举） |
| lifetimes |	组件生命周期声明对象 |
| pageLifetimes |	组件所在页面的生命周期声明对象 |


**properties 定义**

| 定义字段 | 类型 | 是否必填 | 描述 |
| --- | --- | --- | --- |
| type |	| 是 |	属性的类型	|
| optionalTypes	| Array |	否 | 属性的类型（可以指定多个）|
| value	|  |	否 | 属性的初始值 |	
| observer | Function |	否 | 属性值变化时的回调函数 |

```js
Component({

  behaviors: [],

  // 属性定义（详情参见下文）
  properties: {
    myProperty: { // 属性名
      type: String,
      value: ''
    },
    myProperty2: String // 简化的定义方式
  },

  data: {}, // 私有数据，可用于模板渲染

  lifetimes: {
    // 生命周期函数，可以为函数，或一个在methods段中定义的方法名
    attached: function () { },
    moved: function () { },
    detached: function () { },
  },

  // 生命周期函数，可以为函数，或一个在methods段中定义的方法名
  attached: function () { }, // 此处attached的声明会被lifetimes字段中的声明覆盖
  ready: function() { },

  pageLifetimes: {
    // 组件所在页面的生命周期函数
    show: function () { },
    hide: function () { },
    resize: function () { },
  },

  methods: {
    onMyButtonTap: function(){
      this.setData({
        // 更新属性和数据的方法与更新页面数据的方法类似
      })
    },
    // 内部方法建议以下划线开头
    _myPrivateMethod: function(){
      // 这里将 data.A[0].B 设为 'myPrivateData'
      this.setData({
        'A[0].B': 'myPrivateData'
      })
    },
    _propertyChange: function(newVal, oldVal) {

    }
  }

})
```
### 模块化
通过`module.exports`或`exports`暴露接口，小程序不支持直接引入`node_modules`，需要自行处理

模块引用`require`

### 文件作用域
与JS文件声明一样。

### API

#### 事件监听API

一般以on开头 执行回调

#### 同步API

一般以Sync结尾 同步

#### 异步API 

接受对象类型参数 success fail complete 等

回调函数的参数  errMsg errCode 其他

#### 异步API返回Promise

接口参数Object对象不包含success fail complete将默认返回promise。

#### 云开发API

wx.cloud.XXXXXXX

### 视图层
#### WXML
+ 数据绑定 {{xxx}} data设值xxx:???
+ 列表渲染 wx:for 
+ 条件渲染 wx:if else-if else
+ 模板 自定义

#### WXSS
rpx （responsive pixel） 1rpx=0.5px=1物理像素

外联样式的导入 @import 

内联样式 style或class类名

**选择器**

+ **.class**
+ **#id**
+ **element 所有view组件**
+ **element,element 所有文档的view组件和checkbox组件**
+ **::after**
+ **::before**

#### WXS
+ 与JavaScript不同，与js运行环境不同
+ 不能调用其他js函数和小程序提供API
+ ios内允许比js快，安卓无差
+ 不能作为组件回调

.wxs文件

内有module对象通过exports可以导出变量或函数

src属性可以引用wxs文件模块(**必须相对路径**)

模块外引用采用require

### 事件系统
#### 事件使用方式
在组件中绑定一个事件处理函数，然后在Page页面定义相应的事件处理函数，参数为event

wxs函数响应事件中，函数接受两个参数，`event(event.instance)`,`ownerInstance`(包含一些方法，可以设置组件样式和class)

#### 事件分类

冒泡事件 父组件监听

非冒泡事件 

可以通过catch来阻止事件向上冒泡

**互斥事件绑定**

mut-bind

点击`inner view` 触发 `handleTap3` 和 `handleTap2`，点击 `middle view` 调用 `handleTap2` 和 `handleTap1`

```xml
<view id="outer" mut-bind:tap="handleTap1">
  outer view
  <view id="middle" bindtap="handleTap2">
    middle view
    <view id="inner" mut-bind:tap="handleTap3">
      inner view
    </view>
  </view>
</view>
```

#### 事件捕获阶段
捕获阶段监听事件，采用 `capture-bind`、`capture-catch`(中断捕获阶段和取消冒泡阶段)

自定义组件

#### 事件对象
BaseEvent

+ type 
+ timeStamp 生成时时间戳
+ target  触发源
+ currentTarget   绑定当前组件
+ mark 标记数据

CustomEvent

+ detail 额外信息

TouchEvent

+ touches  触摸停留
+ changedTouches 变化的触摸点信息数组

**dataset**组件节点中自定义数据

data-开头 驼峰式

### 简单双向绑定

普通属性是单向绑定，添加 `model` 进行可以进行双向绑定

自定义组件可以传递双向绑定

更新通过setData来设置自身属性



