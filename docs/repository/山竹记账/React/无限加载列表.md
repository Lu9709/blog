# æ— é™åŠ è½½åˆ—è¡¨
### æ”¹é€  Mockï¼Œå¿«é€Ÿåˆ›å»ºå‡æ•°æ®
#### é‡æ„Mock
é‡æ„`item.mock.ts`ï¼Œè¯¦ç»†ä»£ç è§é“¾æ¥ã€‚

```tsx
import type { MockMethod } from 'vite-plugin-mock'

let id = 0
// è‡ªå¢id
const createId = () => {
  id += 1
  return id
}
// åˆ›å»ºå•ä¸ªæ•°æ®
const create = (attrs?: Partial<Item>): Item => {
  return {
    id: createId(),
    user_id: 1,
    amount: 1000,
    tag_ids: [1, 2],
    happen_at: '2021-08-01T00:00:00.000Z',
    created_at: '2021-08-01T00:00:00.000Z',
    updated_at: '2021-08-01T00:00:00.000Z',
    kind: 'expenses',
    ...attrs
  }
}
// åˆ›å»ºæ•°æ®åˆ—è¡¨
const createList = (n: number, attrs?: Partial<Item>): Item[] => {
  return Array.from({ length: n }).map(() => create(attrs))
}
// åˆ›å»ºå“åº”è¿”å›å€¼
const createResponse = ({ count = 10, perPage = 10, page = 1 }, attrs?: Partial<Item>): Resources<Item> => {
  return {
    resources: createList(perPage, attrs),
    pager: {
      page,
      per_page: perPage,
      count
    }
  }
}
// itemæ•°æ®mockæ–¹æ³•
export const itemsMock: MockMethod = {
  url: '/api/v1/items',
  method: 'get',
  statusCode: 200,
  response: ({ query }: ResponseParams): Resources<Item> => createResponse({ count: 100, perPage: 10, page: parseInt(query.page) })
}

```

åˆ›å»º`me.mock.ts`å’Œ`mock.ts`æ–‡ä»¶ï¼Œä¿®æ”¹`test.ts`æ–‡ä»¶ï¼Œæ”¹ä¸ºå¯¼å…¥`meMock`å’Œ`itemsMock`æ–¹æ³•ã€‚

```tsx
import type { MockMethod } from 'vite-plugin-mock'

export const meMock: MockMethod = {
  url: '/api/v1/me',
  method: 'get',
  timeout: 10000,
  response: (): Resource<User> => {
    return {
      resource: {
        id: 1,
        email: 'frank@frank.com',
        updated_at: '2021-08-01T00:00:00.000Z',
        created_at: '2021-08-01T00:00:00.000Z',
      }
    }
  },
}
```

```tsx
type ResponseParams = {
  query: Record<string, string>
}
```

ä¿®æ”¹`ItemsList.tsx`ç»„ä»¶ï¼Œä½¿ç”¨useSWRçš„[useSWRInfinite](https://swr.vercel.app/zh-CN/docs/pagination#useswrinfinite)ï¼Œæ¥å—ä¸€ä¸ª`getKey`æ–¹æ³•ï¼Œç”¨äºè¿”å›é¡µé¢çš„keyï¼Œåœ¨æ¥å—ä¸€ä¸ª`fetcher`ï¼Œç”¨äºè¯·æ±‚æ•°æ®ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å‚æ•°`<font style="color:rgb(0, 0, 0);">options</font>`<font style="color:rgb(0, 0, 0);">å¯ä»¥æ¥å—useSWRçš„é¢å¤–é€‰é¡¹ã€‚</font>

```tsx
import useSWRInfinite from 'swr/infinite'
import { ajax } from '../../lib/ajax'

interface Props {}
const getKey = (pageIndex: number) => {
  return `/api/v1/items?page=${pageIndex + 1}`
}
export const ItemsList: React.FC<Props> = () => {
  const { data, error } = useSWRInfinite(
    getKey,
    async path => (await ajax.get<Resources<Item>>(path)).data
  )
  console.log(data, error)
  const items: Item[] = []
  return <div>
    <ol >
      {items.map(item =>
        <li key={item.id} grid grid-cols="[auto_1fr_auto]" grid-rows-2 px-16px py-8px gap-x-12px
          border-b-1 b="#EEE">
          <div row-start-1 col-start-1 row-end-3 col-end-2 text-24px w-48px h-48px
            bg="#D8D8D8" rounded="50%" flex justify-center items-center>
            ğŸ˜˜
          </div>
          <div row-start-1 col-start-2 row-end-2 col-end-3>
            æ—…è¡Œ
          </div>
          <div row-start-2 col-start-2 row-end-3 col-end-4 text="#999999">
            2011å¹´1æœˆ1æ—¥
          </div>
          <div row-start-1 col-start-3 row-end-2 col-end-4 text="#53A867">
            ï¿¥999
          </div>
        </li>
      )}
    </ol>
    <div p-16px>
      <button j-btn>åŠ è½½æ›´å¤š</button>
    </div>
  </div>
}
```

#### å¼•å…¥FakerJSæ„é€ å‡æ•°æ®
å®‰è£…å‘½ä»¤`pnpm install @faker-js/faker`ï¼Œè¯¦ç»†å‚æ•°é…ç½®å¯è§[@faker-js/faker](https://github.com/faker-js/faker#readme)ã€‚

ä¿®æ”¹`item.mock.ts`æ–‡ä»¶çš„mockæ•°æ®ã€‚

```tsx
import type { MockMethod } from 'vite-plugin-mock'
import { faker } from '@faker-js/faker'

let id = 0
const createId = () => {
  id += 1
  return id
}

const create = (attrs?: Partial<Item>): Item => {
  return {
    id: createId(),
    user_id: 1,
    amount: faker.datatype.number({ min: 99, max: 1000_00 }),
    tag_ids: [1, 2],
    happen_at: faker.date.past().toISOString(),
    created_at: faker.date.past().toISOString(),
    updated_at: faker.date.past().toISOString(),
    kind: 'expenses',
    ...attrs
  }
}

const createList = (n: number, attrs?: Partial<Item>): Item[] => {
  return Array.from({ length: n }).map(() => create(attrs))
}

const createResponse = ({ count = 10, perPage = 10, page = 1 }, attrs?: Partial<Item>): Resources<Item> => {
  return {
    resources: createList(perPage, attrs),
    pager: {
      page,
      per_page: perPage,
      count
    }
  }
}

export const itemsMock: MockMethod = {
  url: '/api/v1/items',
  method: 'get',
  statusCode: 200,
  response: ({ query }: ResponseParams): Resources<Item> => createResponse({ count: 100, perPage: 10, page: parseInt(query.page) })
}

```

#### è¯·æ±‚æ‰€æœ‰é¡µé¢çš„æ•°æ®
```tsx
import type { MockMethod } from 'vite-plugin-mock'
import { faker } from '@faker-js/faker'

let id = 0
const createId = () => {
  id += 1
  return id
}

const create = (attrs?: Partial<Item>): Item => {
  return {
    id: createId(),
    user_id: 1,
    amount: faker.datatype.number({ min: 99, max: 1000_00 }),
    tag_ids: [1, 2],
    happen_at: faker.date.past().toISOString(),
    created_at: faker.date.past().toISOString(),
    updated_at: faker.date.past().toISOString(),
    kind: 'expenses',
    ...attrs
  }
}

const createList = (n: number, attrs?: Partial<Item>): Item[] => {
  return Array.from({ length: n }).map(() => create(attrs))
}

const createResponse = ({ count = 10, perPage = 10, page = 1 }, attrs?: Partial<Item>): Resources<Item> => {
  // pageé¡µä¸Šä¸€ä¸ªé¡µç æ—¶å€™çš„é¡µé¢æ€»æ¡æ•°
  // count é¡µé¢æ€»æ¡æ•°
  const sendCount = (page - 1) * perPage
  // left å½“å‰pageé¡µé¢æ‰€å‰©ä¸‹çš„æ¡æ•°
  const left = count - sendCount
  // åˆ›å»ºæ¡æ•°çš„æ—¶å€™å–æ¯é¡µæ€»æ¡æ•°å’Œå½“å‰pageé¡µé¢æ‰€å‰©ä¸‹çš„æ¡æ•°çš„æœ€å°å€¼
  return {
    resources: left > 0 ? createList(Math.min(left, perPage), attrs) : [],
    pager: {
      page,
      per_page: perPage,
      count
    }
  }
}

export const itemsMock: MockMethod = {
  url: '/api/v1/items',
  method: 'get',
  statusCode: 200,
  response: ({ query }: ResponseParams): Resources<Item> => createResponse({ count: 30, perPage: 10, page: parseInt(query.page) })
}

```

ä¿®æ”¹`itemsList.tsx`

```tsx
import useSWRInfinite from 'swr/infinite'
import { ajax } from '../../lib/ajax'

interface Props {}
const getKey = (pageIndex: number, prev: Resources<Item>) => {
  if (prev) {
    // å½“å‰ä¼ å…¥pageIndexé¡µæ•°çš„æ—¶çš„é¡µé¢æ€»æ¡æ•°
    const sendCount = (prev.pager.page - 1) * prev.pager.per_page + prev.resources.length
    // æ•°æ®æ€»æ¡æ•°
    const count = prev.pager.count
    // sendCount å¤§äº æ•°æ®æ€»æ¡æ•°å°±ä¸ç»§ç»­è¯·æ±‚äº†
    if (sendCount >= count)
      return null
  }
  return `/api/v1/items?page=${pageIndex + 1}`
}
export const ItemsList: React.FC<Props> = () => {
  const { data, error, size, setSize } = useSWRInfinite(
    getKey,
    async path => (await ajax.get<Resources<Item>>(path)).data
  )
  const onLoadMore = () => {
    setSize(size + 1)
  }
  if (!data) {
    return <span>'è¿˜æ²¡æå®š'</span>
  } else {
    return <>
      <ol>{
        data.map(({ resources }) => {
          return resources.map(item =>
            <li key={item.id} grid grid-cols="[auto_1fr_auto]" grid-rows-2 px-16px py-8px gap-x-12px
              border-b-1 b="#EEE">
              <div row-start-1 col-start-1 row-end-3 col-end-2 text-24px w-48px h-48px
                bg="#D8D8D8" rounded="50%" flex justify-center items-center>
                ğŸ˜˜
              </div>
              <div row-start-1 col-start-2 row-end-2 col-end-3>
                æ—…è¡Œ
              </div>
              <div row-start-2 col-start-2 row-end-3 col-end-4 text="#999999">
                2011å¹´1æœˆ1æ—¥
              </div>
              <div row-start-1 col-start-3 row-end-2 col-end-4 text="#53A867">
                ï¿¥{item.amount / 100}
              </div>
            </li>
          )
        })
      }</ol>
      <div p-16px>
        <button j-btn onClick={onLoadMore}>åŠ è½½æ›´å¤š</button>
      </div>
    </>
  }
}
```

### æ²¡æœ‰æ›´å¤šæ•°æ®æ—¶ï¼Œä¸å±•ç¤ºåŠ è½½æŒ‰é’®
è®¾ç½®ä¸€ä¸ª`hasMore`æ ¹æ®è¯·æ±‚åˆ°çš„æ€»æ¡æ•°å’Œåˆ—è¡¨æ€»æ¡æ•°è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæ¯”æ€»æ¡æ•°å°‘åˆ™æ˜¾ç¤ºåŠ è½½æŒ‰é’®ï¼Œå¦åˆ™æ˜¾ç¤ºæ²¡æœ‰æ›´æ•°æ®å†…å®¹ã€‚

```tsx
import useSWRInfinite from 'swr/infinite'
import { ajax } from '../../lib/ajax'

interface Props {}
const getKey = (pageIndex: number, prev: Resources<Item>) => {
  if (prev) {
    const sendCount = (prev.pager.page - 1) * prev.pager.per_page + prev.resources.length
    const count = prev.pager.count
    if (sendCount >= count)
      return null
  }
  return `/api/v1/items?page=${pageIndex + 1}`
}
export const ItemsList: React.FC<Props> = () => {
  const { data, error, size, setSize } = useSWRInfinite(
    getKey,
    async path => (await ajax.get<Resources<Item>>(path)).data
  )
  const onLoadMore = () => {
    setSize(size + 1)
  }
  if (!data) {
    return <span>è¿˜æ²¡æå®š</span>
  } else {
    const last = data[data.length - 1]
    const { pager: { page, per_page, count } } = last
    const hasMore = (page - 1) * per_page + last.resources.length < count
    return <>
      <ol>{
        data.map(({ resources }) => {
          return resources.map(item =>
            <li key={item.id} grid grid-cols="[auto_1fr_auto]" grid-rows-2 px-16px py-8px gap-x-12px
              border-b-1 b="#EEE">
              <div row-start-1 col-start-1 row-end-3 col-end-2 text-24px w-48px h-48px
                bg="#D8D8D8" rounded="50%" flex justify-center items-center>
                ğŸ˜˜
              </div>
              <div row-start-1 col-start-2 row-end-2 col-end-3>
                æ—…è¡Œ
              </div>
              <div row-start-2 col-start-2 row-end-3 col-end-4 text="#999999">
                2011å¹´1æœˆ1æ—¥
              </div>
              <div row-start-1 col-start-3 row-end-2 col-end-4 text="#53A867">
                ï¿¥{item.amount / 100}
              </div>
            </li>
          )
        })
      }</ol>
      {
        hasMore
          ? <div p-16px><button j-btn onClick={onLoadMore}>åŠ è½½æ›´å¤š</button></div>
          : <div p-16px text-center>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</div>
      }
    </>
  }
}
```

### å®ŒæˆåŠ è½½ä¸­å’ŒåŠ è½½å¤±è´¥çš„å±•ç¤ºé€»è¾‘
è®¾ç½®äº†`isLoadingInitialData`ã€`isLoadingMore`ã€`isLoading`è¿™ä¸‰ä¸ªå€¼ã€‚

+ `isLoadingInitialData`ä¸ºæ˜¯å¦åŠ è½½åˆå§‹åŒ–æ•°æ®
+ `isLoadingMore`ä¸ºæ˜¯å¦åŠ è½½æ›´å¤š
+ `isLoading`ä¸º`isLoadingInitialData`å’Œ`isLoadingMore`å¹¶é›†ã€‚

```tsx
import styled from 'styled-components'
import useSWRInfinite from 'swr/infinite'
import { ajax } from '../../lib/ajax'

interface Props {}

const Div = styled.div`
  padding: 16px;
  text-align: center
`
const getKey = (pageIndex: number, prev: Resources<Item>) => {
  if (prev) {
    const sendCount = (prev.pager.page - 1) * prev.pager.per_page + prev.resources.length
    const count = prev.pager.count
    if (sendCount >= count)
      return null
  }
  return `/api/v1/items?page=${pageIndex + 1}`
}
export const ItemsList: React.FC<Props> = () => {
  const { data, error, size, setSize } = useSWRInfinite(
    getKey,
    async path => (await ajax.get<Resources<Item>>(path)).data
  )
  const onLoadMore = () => {
    setSize(size + 1)
  }
  const isLoadingInitialData = !data && !error
  const isLoadingMore = data?.[size - 1] === undefined && !error
  const isLoading = isLoadingInitialData || isLoadingMore
  if (!data) {
    return <div>
      { error && <Div>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</Div> }
      { isLoading && <Div>æ•°æ®åŠ è½½ä¸­...</Div>}
    </div>
  } else {
    const last = data[data.length - 1]
    const { pager: { page, per_page, count } } = last
    const hasMore = (page - 1) * per_page + last.resources.length < count
    return <>
      <ol>{
        data.map(({ resources }) => {
          return resources.map(item =>
            <li key={item.id} grid grid-cols="[auto_1fr_auto]" grid-rows-2 px-16px py-8px gap-x-12px
              border-b-1 b="#EEE">
              <div row-start-1 col-start-1 row-end-3 col-end-2 text-24px w-48px h-48px
                bg="#D8D8D8" rounded="50%" flex justify-center items-center>
                ğŸ˜˜
              </div>
              <div row-start-1 col-start-2 row-end-2 col-end-3>
                æ—…è¡Œ
              </div>
              <div row-start-2 col-start-2 row-end-3 col-end-4 text="#999999">
                2011å¹´1æœˆ1æ—¥
              </div>
              <div row-start-1 col-start-3 row-end-2 col-end-4 text="#53A867">
                ï¿¥{item.amount / 100}
              </div>
            </li>
          )
        })
      }</ol>
      { error && <Div>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</Div> }
      {
        !hasMore
          ? <Div>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</Div>
          : isLoading
            ? <Div>æ•°æ®åŠ è½½ä¸­...</Div>
            : <Div><button j-btn onClick={onLoadMore}>åŠ è½½æ›´å¤š</button></Div>
      }
    </>
  }
}

```

### ä¸ºä»€ä¹ˆSWRä¼šè¯·æ±‚é‚£ä¹ˆå¤šæ¬¡
ä¸ºä»€ä¹ˆè¯·æ±‚é‚£ä¹ˆå¤šæ¬¡ï¼Œè¿™æ˜¯SWRæ•…æ„ä¸ºä¹‹çš„ï¼Œè¯¦ç»†åŸå› è§[é“¾æ¥](https://github.com/vercel/swr/issues/1638)ã€‚

ä¹Ÿå¯ä»¥å…³æ‰å®ƒï¼Œå°†é€‰é¡¹ä¸­è®¾ç½®`revalidateFirstPage: false`ã€‚

SWRå¤šæ¬¡è¯·æ±‚é€‚ç”¨äºæ›´æ–°æ•°æ®çš„ï¼Œé€‚ç”¨çš„åœºæ™¯æ¯”å¦‚å¾®åš Twiterè¿™ç§æ•°æ®æ›´æ–°å¿«çš„ã€‚

å…³é—­**viteçš„è‡ªåŠ¨åˆ·æ–°**ï¼Œåœ¨`vite.config.ts`å†…é…ç½®`server`çš„é€‰é¡¹ä¸º`hmr: false`ã€‚

